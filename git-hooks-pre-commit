#!/bin/bash

# Caminho absoluto para a pasta onde o script estÃ¡
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

PASTA_POSTS="$DIR/posts"
ARQUIVO_LISTA="$DIR/lista.txt"
TMP_LISTA="$DIR/.tmp_lista"

> "$TMP_LISTA"

# Itera sobre os arquivos .md da pasta de posts
for arquivo in "$PASTA_POSTS"/*.md; do
  nome_arquivo=$(basename "$arquivo")
  titulo=$(grep -m 1 '^#' "$arquivo" | sed 's/^#\s*//')

  if [ -z "$titulo" ]; then
    titulo="$nome_arquivo"
  fi

  ultima_linha=$(tail -n 1 "$arquivo")
  data=$(echo "$ultima_linha" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$')

  if [ -z "$data" ]; then
    data=$(date -r "$arquivo" '+%Y-%m-%d')
    echo "" >> "$arquivo"
    echo "$data" >> "$arquivo"
  fi

  echo "${data}|${nome_arquivo}|${titulo}" >> "$TMP_LISTA"
done

# Ordena por data decrescente e salva como lista.txt no formato original
sort -r "$TMP_LISTA" | awk -F'|' '{print $2 "|" $3 "|" $1}' > "$ARQUIVO_LISTA"

rm -f "$TMP_LISTA"

git add "$ARQUIVO_LISTA" "$PASTA_POSTS"/*.md
